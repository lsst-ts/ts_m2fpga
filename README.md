# M2 Cell Controller Field Programmable Gate Arrays (FPGA) Code

## Overview

This project will improve the FPGA code in the [M2 Cell Controller LabVIEW project](https://github.com/lsst-ts/ts_mtm2_cell).
In that version, the VI named **4-port serial Master Slave.vi**, under `Chassis (cRIO-9038) >> FPGA Target (RIO0, cRIO-9038)` in the Project Explorer, interacts with the hardware inputs and outputs.

## Platform

- Windows 10
- LabVIEW 2018 SP1 32-bit
- cRIO-9049 (M2 simulator: m2-crio-simulator.ls.lsst.org)

## Needed Package

- LabVIEW NI Device Drivers (DVD-Jan-19-1)
- LabVIEW 2018 FPGA Module
- LabVIEW 2018 SP1 CompactRIO Module 18.5 (Jan, 2019)
- LabVIEW 2018 FPGA Module Xilinx Compilation Tool for Vivado 2017.2
- FPGA Interface C API 18.0

## NI Package Installation

1. There is the order of NI package installation.
The NI Device Drivers needs to be installed first, followed by Real-Time or FPGA module, and the CompactRIO module is the final one.
2. The details can follow: [Install NI Software for Your CompactRIO System](https://learn.ni.com/learn/article/getting-started-with-compactrio-hardware-and-labview).

## Directory Structure

```text
ts_m2fpga
├── src
│   ├── m2fpga.lvproj
│   ├── mainFPGA.vi
│   ├── switchRelays.vi
│   ├── readDaq.vi
│   ├── ilcCommmunication.vi
├── doc
│   ├── versionHistory.md
│   ├── switchRelays.md
│   ├── readDaq.md
│   ├── ilcCommmunication.md
├── fpgaInterface
│   ├── NiFpga_mainFPGA.h
│   ├── NiFpga.c
│   ├── NiFpga.h
│   ├── NiFpga_mainFPGA.lvbitx
│   ├── bitfile
│       ├── m2fpga_FPGATarget_mainFPGA_<random_characters>.lvbitx
├── README.md
└── .gitignore
```

- `src`: contains the LabVIEW FPGA project.
- `doc`: documentation like `versionHistory.md`.
- `fpgaInterface`: in here are all files generated by the FPGA Interface C API.
- `bitfile`: contains the bitfile (.lvbitx).
The bitfile contains all the configuration information from the LabVIEW block diagram defining the internal logic and digital circuit of the FPGA and device-specific information from other files associated with the FPGA target.
When the FPGA application executes, the bitfile loads on the FPGA chip and reconfigures the gate array logic.
Follow [this link](https://knowledge.ni.com/KnowledgeArticleDetails?id=kA03q000000YHVTCA4&l=en-US) if you want to know more about the LabVIEW FPGA compilation process.

Random characters in the `lvbitx` file name appear when the **mainFPGA.vi** is compiled.

The bitfile and header files will be inside of `fpgaInterface` directory, because they are related to the hardware and need to be as part of the version control.

## FPGA Interface C API

The FPGA Interface C API enables C/C++ applications to interact directly with the compiled LabVIEW FPGA VI on real-time controllers, generating C functions calls to read from and write to named controls and indicators, perform Direct Memory Access (DMA) data transfers, and wait on and acknowledge interrupts.

The following files are generated by the FPGA Interface C API:

- **NiFpga_mainFPGA.h:** C header file that contains all the constants required by function calls in your application. 
- **NiFpga_mainFPGA.lvbitx:** version of the original `.lvbitx` bitfile created after the FPGA compilation, renamed to match the prefix of the constants in the `.h` header file.
- **NiFpga.h:** C header file.
It is identical for all generated C APIs.
It declares all the errors, types, constants, and functions needed to write an application.
Most of these functions are defined in `NiFpga.c`.
- **NiFpga.c:** C source file that you must include in your application.
It is identical for all generated C APIs.
It defines all the functions your application can call. 
`NiFpga.c` loads and unloads the `NiFpga` library at runtime, and forwards function calls to that library.

The FPGA Interface C API Generator names files and constants based on the name of the FPGA VI from which the application bitfile was compiled, like this:

```
NiFpga_<FPGA_VI_name>.h
```

For instance, if the FPGA VI name is **mainFPGA.vi**, the header file will be named `NiFpga_mainFPGA.h`.

Follow this link with a [FPGA C API Demo](https://confluence.lsstcorp.org/display/LTS/FPGA+C+API+Interface+Demo).

## FPGA VIs

The main LabVIEW FPGA code will be named **mainFPGA.vi** and it will call three VIs running in parallel: (1) **switchRelays.vi**, (2) **readDaq.vi**, and (3) **ilcCommmunication.vi**.

### switchRelays VI

This VI will be in `src/` directory.
Follow [here](doc/switchRelays.md) for details.

### readDaq VI

This VI will be explained in this [JIRA ticket](https://jira.lsstcorp.org/browse/DM-35829).

### ilcCommunication VI

This VI will be explained in this [JIRA ticket](https://jira.lsstcorp.org/browse/DM-35830).
